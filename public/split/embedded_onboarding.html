<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Embedded Onboarding (Stripe Connect)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --border: #e5e7eb;
        --muted: #6b7280;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 24px;
      }
      .card {
        max-width: 880px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      label {
        width: 160px;
        color: var(--muted);
      }
      input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      button {
        padding: 10px 14px;
        border: 0;
        border-radius: 10px;
        cursor: pointer;
      }
      button.primary {
        background: #111827;
        color: white;
      }
      button.secondary {
        background: #f3f4f6;
      }
      #onboarding {
        margin-top: 20px;
      }
      #status,
      #accountJson {
        margin-top: 12px;
      }
      pre {
        background: #0b1020;
        color: #e5e7eb;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
        max-height: 360px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #f3f4f6;
        font-size: 12px;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .spacer {
        height: 8px;
      }
      .group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Stripe Connect Onboarding</h2>
      <p class="small">
        Crie uma nova Connected Account (redirecionamento direto para onboarding da Stripe) ou 
        reutilize uma conta existente (onboarding embarcado nesta página).
      </p>

      <div class="row">
        <label>Email do Expert</label>
        <input id="email" placeholder="expert+t1@example.com" value="expert+t14@example.com" />
      </div>
        <div class="row">
          <label>Account ID (opcional)</label>
          <input id="accountId" placeholder="acct_..." />
          <button class="secondary" id="copyAcct">copiar</button>
        </div>

      <div class="row group">
        <button class="primary" id="start">Iniciar Onboarding</button>
        <button class="secondary" id="check">Ver status da conta</button>
        <button class="secondary" id="reopen">Reabrir Onboarding</button>
      </div>

      <div id="status"></div>
      <div id="onboarding"></div>

      <div class="spacer"></div>
      <div id="accountJson"></div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
      // Publishable key do .env (exposta pelo PHP)
      const PUBLISHABLE_KEY =
        "<?php echo htmlspecialchars(getenv('STRIPE_PUBLISHABLE_KEY') ?? 'pk_test_xxx', ENT_QUOTES); ?>";

      // Inicializa o Stripe
      const stripe = Stripe(PUBLISHABLE_KEY);

      const $email = document.getElementById("email");
      const $accountId = document.getElementById("accountId");
      const $status = document.getElementById("status");
      const $accountJson = document.getElementById("accountJson");
      const $onboarding = document.getElementById("onboarding");

      const $start = document.getElementById("start");
      const $check = document.getElementById("check");
      const $reopen = document.getElementById("reopen");
      const $copyAcct = document.getElementById("copyAcct");

      function setStatus(text) {
        $status.innerHTML = `<span class="pill">Status</span> <span class="small">${text}</span>`;
      }
      function showAccountJson(obj) {
        $accountJson.innerHTML = `<div class="pill">account_status</div><pre>${JSON.stringify(
          obj,
          null,
          2
        )}</pre>`;
      }
      function clearOnboarding() {
        $onboarding.innerHTML = "";
      }

      // Cria/recupera Account Session no backend e retorna client_secret + acct
      async function createAccountSession(acctId = null, email = null) {
        const body = {};
        
        // Se tem email, nunca enviar account_id
        if (email) {
          body.email = email;
          console.log('DEBUG: Enviando apenas email:', email);
        } else if (acctId) {
          body.account_id = acctId;
          console.log('DEBUG: Enviando apenas account_id:', acctId);
        }
        
        console.log('DEBUG: Body sendo enviado:', JSON.stringify(body));

        const res = await fetch("./create_account_session.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!data.success) throw new Error((data.details && data.details.message) || data.error || "Falha ao criar Account Session");
        const out = data.data || {};
        return { clientSecret: out.client_secret, accountId: out.account_id };
      }

      // Wrapper: se a conta não existir, tenta criar uma nova usando o email
      async function createAccountSessionWithFallback(acctId = null, email = null) {
        try {
          return await createAccountSession(acctId, email);
        } catch (err) {
          const msg = (err && err.message) ? String(err.message) : '';
          if (acctId && email && msg.includes('No such account')) {
            // Tentativa automática: criar nova conta ignorando o acct fornecido
            return await createAccountSession(null, email);
          }
          throw err;
        }
      }


      async function fetchAccountStatus(acct) {
        const res = await fetch("./account_status.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ account_id: acct }),
        });
        const data = await res.json();
        if (!data.success) throw new Error((data.details && data.details.message) || data.error || "Falha ao consultar status");
        return data.data;
      }

      async function createOnboardingLink(acctId) {
        const res = await fetch("./create_onboarding_link.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ account_id: acctId }),
        });
        const data = await res.json();
        if (!data.success) throw new Error((data.details && data.details.message) || data.error || "Falha ao criar link de onboarding");
        return (data.data || {}).url;
      }


      // Trata retorno/refresh do Stripe (query params)
      (function handleReturnParams() {
        const params = new URLSearchParams(window.location.search);
        const status = params.get('status');
        const acct = params.get('account');
        if (acct) {
          $accountId.value = acct;
        }
        if (status === 'return') {
          setStatus('Você retornou do onboarding. Verificando status…');
          if (acct) {
            fetchAccountStatus(acct)
              .then((st) => {
                setStatus('Onboarding concluído (ou em revisão). Status abaixo.');
                showAccountJson(st);
              })
              .catch((e) => setStatus('Falha ao consultar status: ' + e.message));
          }
        } else if (status === 'refresh') {
          setStatus('Sessão expirada/cancelada. Você pode reabrir o onboarding.');
        }
      })();

      // Botões
      $start.addEventListener("click", async () => {
        try {
          setStatus("criando account session…");
          const email = $email.value.trim() || null;
          let acctInput = ($accountId.value || '').trim() || null;

          // DEBUG: mostrar o que está sendo enviado
          console.log('DEBUG Frontend - Email:', email, 'Account ID:', acctInput);

          // Se tem email, sempre criar nova conta (ignorar account_id)
          if (email) {
            $accountId.value = '';
            acctInput = null;
            console.log('DEBUG: Email fornecido, limpando account_id');
          }

          const { accountId, clientSecret } = await createAccountSession(acctInput, email);
          $accountId.value = accountId;
          
          // Se é uma nova conta (não veio account_id), redireciona direto para onboarding
          if (!acctInput && email) {
            console.log('DEBUG: Criando onboarding link para nova conta:', accountId);
            setStatus(`Conta: ${accountId} — criando link de onboarding…`);
            try {
              // Abrir onboarding (redirecionar para Stripe)
              console.log('DEBUG: Chamando createOnboardingLink...');
              const onboardingUrl = await createOnboardingLink(accountId);
              console.log('DEBUG: URL do onboarding:', onboardingUrl);
              setStatus(`Conta: ${accountId} — redirecionando para onboarding da Stripe...`);
              window.location.href = onboardingUrl;
              
            } catch (e) {
              console.error('DEBUG: Erro detalhado:', e);
              setStatus(`Conta: ${accountId} — erro: ${e.message}`);
            }
          } else {
            // Conta existente - redirecionar para onboarding externo
            setStatus(`Conta: ${accountId} — criando link de onboarding…`);
            const onboardingUrl = await createOnboardingLink(accountId);
            setStatus(`Conta: ${accountId} — redirecionando para onboarding da Stripe...`);
            window.location.href = onboardingUrl;
          }
        } catch (e) {
          // Superfície de erro mais clara
          setStatus("Erro: " + (e?.message || 'Falha desconhecida'));
        }
      });

      $reopen.addEventListener("click", async () => {
        const acct = $accountId.value.trim();
        if (!acct) {
          setStatus("Informe um Account ID (acct_...)");
          return;
        }
        try {
          setStatus("criando link de onboarding…");
          const url = await createOnboardingLink(acct);
          setStatus(`Conta: ${acct} — abrindo onboarding em nova aba...`);
          window.open(url, "_blank");
        } catch (e) {
          setStatus("Erro ao reabrir: " + e.message);
        }
      });

      $check.addEventListener("click", async () => {
        const acct = $accountId.value.trim();
        if (!acct) {
          setStatus("Informe um Account ID (acct_...).");
          return;
        }
        try {
          setStatus("consultando status…");
          const st = await fetchAccountStatus(acct);
          setStatus("Status carregado abaixo.");
          showAccountJson(st);
        } catch (e) {
          setStatus("Erro ao consultar status: " + e.message);
        }
      });


      $copyAcct.addEventListener("click", async () => {
        const v = $accountId.value.trim();
        if (!v) return;
        try {
          await navigator.clipboard.writeText(v);
          setStatus("Account ID copiado.");
        } catch {
          setStatus("Não foi possível copiar.");
        }
      });
    </script>
  </body>
</html>
