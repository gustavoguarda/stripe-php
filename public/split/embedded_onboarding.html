<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Embedded Onboarding (Stripe Connect)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --border: #e5e7eb;
        --muted: #6b7280;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 24px;
      }
      .card {
        max-width: 880px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      label {
        width: 160px;
        color: var(--muted);
      }
      input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      button {
        padding: 10px 14px;
        border: 0;
        border-radius: 10px;
        cursor: pointer;
      }
      button.primary {
        background: #111827;
        color: white;
      }
      button.secondary {
        background: #f3f4f6;
      }
      #onboarding {
        margin-top: 20px;
      }
      #status,
      #accountJson {
        margin-top: 12px;
      }
      pre {
        background: #0b1020;
        color: #e5e7eb;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
        max-height: 360px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #f3f4f6;
        font-size: 12px;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .spacer {
        height: 8px;
      }
      .group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Embedded Onboarding</h2>
      <p class="small">
        Crie ou reutilize uma Connected Account e carregue o formulário de
        onboarding diretamente nesta página.
      </p>

      <div class="row">
        <label>Email do Expert</label>
        <input id="email" placeholder="expert+t1@example.com" />
      </div>
      <div class="row">
        <label>Account ID (opcional)</label>
        <input id="accountId" placeholder="acct_..." />
        <button class="secondary" id="copyAcct">copiar</button>
      </div>

      <div class="row group">
        <button class="primary" id="start">Iniciar Onboarding</button>
        <button class="secondary" id="check">Ver status da conta</button>
        <button class="secondary" id="prefill">Pré-preencher conta (PF)</button>
        <button class="secondary" id="reopen">Reabrir Onboarding</button>
      </div>

      <div id="status"></div>
      <div id="onboarding"></div>

      <div class="spacer"></div>
      <div id="accountJson"></div>
    </div>

    <!-- Stripe.js (inclui funcionalidades do Connect) -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
      // Publishable key do .env (exposta pelo PHP)
      const PUBLISHABLE_KEY =
        "<?php echo htmlspecialchars(getenv('STRIPE_PUBLISHABLE_KEY') ?? 'pk_test_xxx', ENT_QUOTES); ?>";

      // Inicializa o Stripe
      const stripe = Stripe(PUBLISHABLE_KEY);

      const $email = document.getElementById("email");
      const $accountId = document.getElementById("accountId");
      const $status = document.getElementById("status");
      const $accountJson = document.getElementById("accountJson");
      const $onboarding = document.getElementById("onboarding");

      const $start = document.getElementById("start");
      const $check = document.getElementById("check");
      const $prefill = document.getElementById("prefill");
      const $reopen = document.getElementById("reopen");
      const $copyAcct = document.getElementById("copyAcct");

      function setStatus(text) {
        $status.innerHTML = `<span class="pill">Status</span> <span class="small">${text}</span>`;
      }
      function showAccountJson(obj) {
        $accountJson.innerHTML = `<div class="pill">account_status</div><pre>${JSON.stringify(
          obj,
          null,
          2
        )}</pre>`;
      }
      function clearOnboarding() {
        $onboarding.innerHTML = "";
      }
      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      // Aguarda Connect.js carregar (window.StripeConnect existir)
      async function initConnectInstance(fetchClientSecretFn) {
        const instance = await window.StripeConnect.init({
          publishableKey: PUBLISHABLE_KEY,
          fetchClientSecret: async () => {
            const { clientSecret } = await fetchClientSecretFn();
            return clientSecret;
          },
          appearance: { variables: { colorPrimary: "#111827" } },
        });
        return instance;
      }

      // Cria/recupera Account Session no backend e retorna client_secret + acct
      async function getClientSecret(acctId = null, email = null) {
        const body = {};
        if (acctId) body.account_id = acctId;
        if (email) body.email = email;

        const res = await fetch("./create_account_session.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!data.success)
          throw new Error(data.error || "Falha ao criar Account Session");
        if (!acctId) $accountId.value = data.account_id; // guarda o acct_ gerado
        return { clientSecret: data.client_secret, accountId: data.account_id };
      }

      async function initConnectInstance(fetchClientSecretFn, acctId) {
        // Aguarda o Stripe carregar
        if (typeof Stripe === "undefined") {
          throw new Error("Stripe não carregou. Verifique sua conexão.");
        }

        const { clientSecret } = await fetchClientSecretFn();

        // Para Connect embedded onboarding, usamos a API correta
        // Verifica se embeddedOnboarding existe, senão usa uma abordagem alternativa
        let connectOnboarding;
        if (typeof stripe.embeddedOnboarding === "function") {
          connectOnboarding = stripe.embeddedOnboarding({
            clientSecret: clientSecret,
            onReady: () => {
              console.log("Embedded onboarding ready");
            },
            onExit: (ev) => {
              console.log("Embedded onboarding exit", ev);
            },
            onComplete: (ev) => {
              console.log("Embedded onboarding complete", ev);
            },
          });
        } else {
          // Fallback: cria um link de onboarding
          const onboardingLink = await createOnboardingLink(acctId);
          window.open(onboardingLink, "_blank");
          throw new Error(
            "API de embedded onboarding não disponível. Abrindo link de onboarding em nova aba..."
          );
        }

        return connectOnboarding;
      }

      async function mountOnboarding(fetchClientSecretFn, acctId) {
        clearOnboarding();
        const connectOnboarding = await initConnectInstance(
          fetchClientSecretFn,
          acctId
        );

        // Monta o componente
        connectOnboarding.mount("#onboarding");
      }

      async function fetchAccountStatus(acct) {
        const res = await fetch("./account_status.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ account_id: acct }),
        });
        const data = await res.json();
        if (!data.success)
          throw new Error(data.error || "Falha ao consultar status");
        return data;
      }

      async function createOnboardingLink(acctId) {
        const res = await fetch("./create_onboarding_link.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ account_id: acctId }),
        });
        const data = await res.json();
        if (!data.success)
          throw new Error(data.error || "Falha ao criar link de onboarding");
        return data.url;
      }

      // Botões
      $start.addEventListener("click", async () => {
        try {
          setStatus("criando account session…");
          const acctInput = $accountId.value.trim() || null;
          const email = $email.value.trim() || null;

          const { accountId } = await getClientSecret(acctInput, email);
          setStatus(`Conta: ${accountId} — montando componente…`);

          await mountOnboarding(
            async () => await getClientSecret(accountId, null),
            accountId
          );
        } catch (e) {
          setStatus("Erro: " + e.message);
        }
      });

      $reopen.addEventListener("click", async () => {
        const acct = $accountId.value.trim();
        if (!acct) {
          setStatus("Informe um Account ID (acct_...)");
          return;
        }
        try {
          setStatus("recriando account session…");
          await mountOnboarding(
            async () => await getClientSecret(acct, null),
            acct
          );
          setStatus(`Conta: ${acct} — componente reaberto.`);
        } catch (e) {
          setStatus("Erro ao reabrir: " + e.message);
        }
      });

      $check.addEventListener("click", async () => {
        const acct = $accountId.value.trim();
        if (!acct) {
          setStatus("Informe um Account ID (acct_...).");
          return;
        }
        try {
          setStatus("consultando status…");
          const st = await fetchAccountStatus(acct);
          setStatus("Status carregado abaixo.");
          showAccountJson(st);
        } catch (e) {
          setStatus("Erro ao consultar status: " + e.message);
        }
      });

      $prefill.addEventListener("click", async () => {
        const acct = $accountId.value.trim();
        if (!acct) {
          setStatus("Informe um Account ID (acct_...) para pré-preencher.");
          return;
        }
        setStatus("pré-preenchendo dados básicos (PF)…");
        try {
          const res = await fetch("./prefill_account.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              account_id: acct,
              business_profile: {
                product_description:
                  "Plataforma de consultorias especializadas",
                url: "https://sua-plataforma.test",
              },
              individual: {
                first_name: "Gustavo",
                last_name: "Guarda",
                email: $email.value.trim() || "expert+t1@example.com",
                id_number: "000.000.001-91",
                dob: { day: 1, month: 1, year: 1990 },
                address: {
                  line1: "Rua Teste 123",
                  city: "Brasília",
                  state: "DF",
                  postal_code: "70000-000",
                  country: "BR",
                },
              },
            }),
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          setStatus(
            "Dados básicos enviados. Reabra o onboarding para completar documento e banco."
          );
          const st = await fetchAccountStatus(acct);
          showAccountJson(st);
        } catch (e) {
          setStatus("Erro no pré-preenchimento: " + e.message);
        }
      });

      $copyAcct.addEventListener("click", async () => {
        const v = $accountId.value.trim();
        if (!v) return;
        try {
          await navigator.clipboard.writeText(v);
          setStatus("Account ID copiado.");
        } catch {
          setStatus("Não foi possível copiar.");
        }
      });
    </script>
  </body>
</html>
